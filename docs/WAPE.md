# PE_2D_WAPE Documentation

## Overview

The `PE_2D_WAPE` program is a Fortran implementation designed to perform 2D Parabolic Equation (PE) simulations for wave propagation in various media.
The program utilizes several modules to handle different aspects of the simulation, including reading input parameters, initializing domains, performing wave propagation, and writing output data.

## Modules

### `types`

This module defines various data types used throughout the program. 
These types include structures for simulation parameters, domain definitions, mesh configurations, and more.

### `splines`

This module provides functionalities for to spline interpolation, which are used for interpolating data on different grids.

### `utils`

This module contains utility functions that assist in various computational tasks, such as mathematical operations and data manipulation.

### `interpo`

This module handles interpolation tasks, providing functions to interpolate flow or acoustic data between different mesh grids.

### `read_write`

This module is responsible for reading input data from configuration files and writing output data to files. It supports reading HDF5 files for flow field data.

### `wape`

This module contains the core wave propagation algorithms. 
It includes subroutines for different WAPE formulation, such as arbitrary Mach number (Ostashev et al 2020) propagation and classic wave propagation (Salomons 2001).

### `init`

This module handles the initialization of various parameters and domains required for the simulation.

## Main Program

### `PE_2D_WAPE`

The main program `PE_2D_WAPE` follows these steps:

1. **Read Parameters**: Reads simulation parameters from an input configuration file `input.nml`.
2. **Read Flow Field**: If external flow is enabled, reads the flow field data from an HDF5 file.
3. **Initialize Domain and Mesh**: Initializes the domain and mesh for each propagation angle.
4. **Interpolate Mean Flow**: Interpolates the mean flow over the coarse grid.
5. **Loop Over Frequencies**: For each frequency, initializes the mesh and performs wave propagation.
6. **Perform Wave Propagation**: Executes the wave propagation algorithm for each frequency and angle.
7. **Interpolate and Write Output**: Interpolates the results and writes the output data to files.
8. **Deallocate Memory**: Deallocates memory used for mesh and flow data.

## Subroutines

### `propa_1angle_1freq_arbitrary`

This subroutine performs wave propagation for a single angle and frequency using an arbitrary Mach number approach.
It initializes the necessary parameters, sets up the PML (Perfectly Matched Layer), and solves the wave propagation equation (arbitrary Mach Ostashev 2020).

### `propa_1angle_1freq`

This subroutine performs classic wave propagation for a single angle and frequency. 
It follows a similar structure to `propa_1angle_1freq_arbitrary` but uses a different set of equations for the wave propagation (classic WAPE from salomons 2001).

### `propa_1angle_1freq_arbitrary_new`

This subroutine is an alternative implementation of the arbitrary Mach number wave propagation.
It includes some modifications to the wave propagation equations (Arbitrary mach and phase preserving Ostashev 2023).

### `propa_1angle_1freq_arbitrary2`

This subroutine is another variant of the arbitrary Mach number wave propagation, with further modifications to the wave propagation equations.

## Usage

To use the `PE_2D_WAPE` program, follow these steps:

1. **Prepare Input Files**: Create the necessary input configuration files and HDF5 flow field files.
2. **Compile the Program**: Compile the Fortran code using a Fortran compiler that supports the required modules.
3. **Run the Simulation**: Execute the compiled program, providing the input configuration file as an argument.
4. **Analyze Output**: Review the output data files generated by the simulation for analysis.

## Dependencies

- Fortran compiler (e.g., `gfortran`, `ifort`)
- HDF5 library for reading and writing HDF5 files


# Input for the simulation

## Overview

The `PE_2D_WAPE` program requires a set of input parameters to configure and run the simulation. 
These parameters are grouped logically into different categories such as general parameters, frequencies, angles, domain definition, numerical parameters, source parameters, external flow parameters, and output parameters.

## Input Parameters

### General Parameters

These parameters define the basic settings for the simulation.

- `case_name`: A string identifying the case name.

- `var0%c`: Speed of sound in the medium (default: 343 m/s).


- `var0%rho`: Density of the medium (default: 1.2 kg/mÂ³).

- `var0%gamma`: Ratio of specific heats (default: 1.4).

### Frequencies

These parameters define the frequencies at which the simulation will be run.

- `nb_freq`: Number of frequencies.

- `frequencies`: Array of frequencies (in Hz).

### Angles

These parameters define the angles at which the simulation will be run.

- `nb_theta`: Number of angles.

- `theta`: Array of angles (in degrees).

### Domain Definition

These parameters define the physical dimensions of the simulation domain.

- `Lx1`: Length of the domain in the positive x-direction.

- `Lx2`: Length of the domain in the negative x-direction.

- `Ly1`: Length of the domain in the positive y-direction.

- `Ly2`: Length of the domain in the negative y-direction.

- `Lz`: Length of the domain in the z-direction.

### Numerical Parameters

These parameters define the numerical settings for the simulation.

- `dx`: Grid spacing in the x-direction.

- `cfl`: Courant-Friedrichs-Lewy number for stability.

#### PML (Perfectly Matched Layer)

- `size`: Size of the PML.

- `param`: PML parameter.

- `n`: PML exponent.

#### Impedance (Variable porosity from Attenborough et al 2010)

- `imp%sigmae`: Effective flow resistivity for impedance.

- `imp%alphae`: Effective porosity change rate for impedance.

- `imp%rigid`: Boolean flag for rigid impedance.
  ```fortran
  imp%rigid=.false.
  ```

### Source Parameters

These parameters define the source location and properties.

- `src%pos_x`: x-coordinate of the source.

- `src%pos_z`: z-coordinate of the source.

### External Flow Parameters

These parameters define the external flow settings.

- `external_flow`: Boolean flag to enable reading from Twente LES data.

- `uniform`: Boolean flag for constant flow equal to `u0`.

- `logarithmic`: Boolean flag for logarithmic profile with `z0=0.002`.

- `u0`: Constant flow velocity.

- `arbitrary`: Boolean flag to enable Ostashev WAPE (Ostashev et al 2020 JASA).

- `arbitrary_new`: Boolean flag to enable new phase-preserving WAPE (Ostasheb et al 2024 JASA).

- `fdir`: Path to LES data.

#### Twente Parameters

These parameters are needed to rescale and position the flow.

- `fname`: Filename for Twente data.

- `tinput%ratio`: Ratio for Twente data (used to rescale the flow by $u_*$).

- `tinput%z_i`: length scaling for Twente data.

- `tinput%delta`: Delta for Twente data.

- `tinput%T_scale_K`: Temperature scale for Twente data.

- `tinput%Lx`: Length in the x-direction for Twente data (before rescaling).

- `tinput%Ly`: Length in the y-direction for Twente data (before rescaling).

- `tinput%Lz`: Length in the z-direction for Twente data (before rescaling).

- `tinput%posx`: x-coordinate position for Twente data (before rescaling).

- `tinput%posy`: y-coordinate position for Twente data (before rescaling).

- `tinput%posz`: z-coordinate position for Twente data (before rescaling).

### Output Parameters

These parameters define the output settings for the simulation.

- `dout`: Output  space interval.

- `nb_receiver`: Number of receivers.

- `heights`: Array of heights for receivers.

- `side`: Boolean flag to enable side output to be saved.

- `top`: Boolean flag to enable top output (currently not functional).

- `continuation`: Boolean flag to enable continuation from the last computed angles.

- `nb_xplane`: Number of x-planes where the solution must be recorded.

- `xplane`: Array of x-coordinates for the planes.

- `nb_yplane`: Number of y-planes where the solution must be recorded.

- `yplane`: Array of y-coordinates for the planes.

## Example Input File

```fortran
$input
! general parameters
!------------------------------------------------------------------------------
case_name='c0'
var0%c=343
var0%rho=1.2
var0%gamma=1.4

! Frequencies
nb_freq=4
frequencies(1)=50,100,200,500

! Angles
nb_theta=1
theta(1)=0

! Domain definition
Lx1=3500.0
Lx2=500.0
Ly1=1000.0
Ly2=1000.0
Lz=300

! Numerical parameters
!------------------------------------------------------------------------------
dx=0.5
cfl=0.1
! PML
size=30
param=50000.0
n=2.5
! impedance
imp%sigmae=50000.0
imp%alphae=100.0
imp%rigid=.false.

! Source
src%pos_x=0.0
src%pos_z=90

! External Flow
!------------------------------------------------------------------------------
! if .true. read from twente LES
external_flow=.true.
! if .true. constant flow equal to u0
uniform=.false.

! if .true. log profile with z0=0.002
logarithmic=.false.
u0=11

! Set the type of WAPE used
! if .true. Ostashev WAPE, else classic WAPE
arbitrary=.true.

! if true newa phase preserving WAPE
arbitrary_new=.false.

! (i am not sure this does somethind)
interpolation=.true.

! path to LES data
fdir='/store/lmfa-2/acoustique-nl/simu_jules/LES/2T/C1/blue/output/'

! twente paramaters needed to rescale and positionned the flow
fname='tavg'
tinput%ratio=1
tinput%z_i=1000.0
tinput%delta=0.25
tinput%T_scale_K=293.15
tinput%Lx=6.0
tinput%Ly=3.44
tinput%Lz=1.0
tinput%posx=1.0
tinput%posy=1.72
tinput%posz=0.04

! Set output paramaters
!------------------------------------------------------------------------------
dout=1
nb_receiver=3
heights(1)=2.0, 10, 100
side=.true.

! does not doe anything
top=.false.

! if continuation set to true resart from the last computed angles
! not yet a continuation with respect to frequency
continuation=.false.

! Set the plane in the complete domain where the solution must be recorded
nb_xplane=1
xplane(1)=1000
nb_yplane=1
yplane(1)=1000
$end input
```

This documentation provides a comprehensive overview of the input parameters required for the `PE_2D_WAPE` program, grouped logically for better understanding and configuration.
